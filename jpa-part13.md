# 트랜잭션 범위의 영속성 컨텍스트

### 스프링 컨테이너의 기본 전략
- 트랜잭션의 범위와 영속성 컨텍스트의 생존 범위가 같다. ***즉, 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고 트랜잭션이 끝날 때 영속성 컨텍스트를 종료한다.***
![jpa13-1](https://user-images.githubusercontent.com/22884224/210138495-a1d430d9-5f62-431f-9001-485bb213b49e.png)
- @Transactional을 사용하여 트랜잭션을 시작하게 되는데, 단순 호출처럼 보이는 부분도 사실 스프링의 트랜잭션 AOP가 먼저 작동하게 된다.
![jpa13-2](https://user-images.githubusercontent.com/22884224/210138500-054a0fbc-a785-4c60-9bdb-54a163fa9aa3.png)

### 트랜잭션이 같으면 같은 영속성 컨텍스트를 사용한다.
- 엔티티 매니저를 사용하는 A,B 코드는 모두 같은 트랜잭션 범위에 있다. 따라서 엔티티 매니저는 달라도 같은 영속성 컨텍스트를 사용한다.
![jpa13-3](https://user-images.githubusercontent.com/22884224/210138611-a50316af-1bc8-416c-9b6f-09ca5dfd0ca8.png)

### 트랜잭션이 다르면 다른 영속성 컨텍스트를 사용한다.
- 여러 스레드에서 동시에 요청이 와서 같은 엔티티 매니저를 사용해도 트랜잭션에 따라 접근하는 영속성 컨텍스트가 다르다. 스프링 컨테이너는 스레드 마다 각각 다른 트랜잭션을 할당한다.
![jpa13-4](https://user-images.githubusercontent.com/22884224/210138629-0a280c2b-d815-41ac-8228-2b9809ac110d.png)
